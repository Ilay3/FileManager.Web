<div id="accessModal" class="modal modal-exit" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Настройки доступа</h3>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Пользователи</label>
                <div id="usersList" class="checkbox-list"></div>
            </div>
            <div class="form-group">
                <label>Группы</label>
                <div id="groupsList" class="checkbox-list"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAccessModal()">Отмена</button>
            <button class="btn btn-primary" onclick="submitAccess()">Сохранить</button>
        </div>
    </div>
</div>

<script>
    let accessTarget = { id: null, isFolder: true };
    let currentAccess = [];

    async function openAccessModal(targetId, isFolder) {
        accessTarget = { id: targetId, isFolder: isFolder };
        const modal = document.getElementById('accessModal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.remove('modal-exit');
            modal.classList.add('modal-enter');
        }, 10);
        await loadAccessLists();
        await loadCurrentAccess();
    }

    function closeAccessModal() {
        const modal = document.getElementById('accessModal');
        modal.classList.remove('modal-enter');
        modal.classList.add('modal-exit');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }

    async function loadAccessLists() {
        const [usersRes, groupsRes] = await Promise.all([
            fetch('/api/users', { credentials: 'include' }),
            fetch('/api/groups', { credentials: 'include' })
        ]);
        const users = usersRes.ok ? await usersRes.json() : [];
        const groups = groupsRes.ok ? await groupsRes.json() : [];

        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        users.forEach(u => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" class="access-user" value="${u.id}"> ${u.fullName}`;
            usersList.appendChild(label);
        });

        const groupsList = document.getElementById('groupsList');
        groupsList.innerHTML = '';
        groups.forEach(g => {
            const label = document.createElement('label');
            label.className = 'checkbox-item';
            label.innerHTML = `<input type="checkbox" class="access-group" value="${g.id}"> ${g.name}`;
            groupsList.appendChild(label);
        });
    }

    async function loadCurrentAccess() {
        const url = accessTarget.isFolder
            ? `/api/access/folder/${accessTarget.id}`
            : `/api/access/file/${accessTarget.id}`;
        const res = await fetch(url, { credentials: 'include' });
        currentAccess = res.ok ? await res.json() : [];

        currentAccess.forEach(r => {
            if (r.userId) {
                const cb = document.querySelector(`.access-user[value="${r.userId}"]`);
                if (cb) {
                    cb.checked = true;
                    cb.dataset.ruleId = r.id;
                }
            }
            if (r.groupId) {
                const cb = document.querySelector(`.access-group[value="${r.groupId}"]`);
                if (cb) {
                    cb.checked = true;
                    cb.dataset.ruleId = r.id;
                }
            }
        });
    }

    async function submitAccess() {
        const userCheckboxes = Array.from(document.querySelectorAll('.access-user'));
        const groupCheckboxes = Array.from(document.querySelectorAll('.access-group'));
        const toGrant = [];
        const toRevoke = [];

        userCheckboxes.forEach(cb => {
            if (cb.checked) {
                if (!cb.dataset.ruleId) {
                    toGrant.push({
                        fileId: accessTarget.isFolder ? null : accessTarget.id,
                        folderId: accessTarget.isFolder ? accessTarget.id : null,
                        userId: cb.value,
                        groupId: null,
                        accessType: 1,
                        inherit: true
                    });
                }
            } else if (cb.dataset.ruleId) {
                toRevoke.push(cb.dataset.ruleId);
            }
        });

        groupCheckboxes.forEach(cb => {
            if (cb.checked) {
                if (!cb.dataset.ruleId) {
                    toGrant.push({
                        fileId: accessTarget.isFolder ? null : accessTarget.id,
                        folderId: accessTarget.isFolder ? accessTarget.id : null,
                        userId: null,
                        groupId: cb.value,
                        accessType: 1,
                        inherit: true
                    });
                }
            } else if (cb.dataset.ruleId) {
                toRevoke.push(cb.dataset.ruleId);
            }
        });

        if (toGrant.length > 0) {
            const res = await fetch('/api/access/bulk-grant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rules: toGrant }),
                credentials: 'include'
            });
            if (!res.ok) {
                const errorText = await res.text();
                console.error(errorText);
                if (res.status === 401 || res.status === 403) {
                    alert('Необходимо авторизоваться');
                } else {
                    alert(`Ошибка сохранения прав доступа: ${errorText}`);
                }
            }
        }

        for (const id of toRevoke) {
            const res = await fetch(`/api/access/${id}`, { method: 'DELETE', credentials: 'include' });
            if (!res.ok) {
                const errorText = await res.text();
                console.error(errorText);
                if (res.status === 401 || res.status === 403) {
                    alert('Необходимо авторизоваться');
                    break;
                } else {
                    alert(`Ошибка удаления прав доступа: ${errorText}`);
                }
            }
        }

        closeAccessModal();
    }
</script>
