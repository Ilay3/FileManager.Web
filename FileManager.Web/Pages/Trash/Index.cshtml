@page "/Trash"
@model FileManager.Web.Pages.Trash.IndexModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@{
    ViewData["Title"] = "Корзина";
}

<h2>Корзина</h2>

<table class="table">
    <thead>
        <tr>
            <th>Название</th>
            <th>Тип</th>
            <th>Удалено</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model.Items)
    {
        <tr id="item-@item.Id">
            <td>@item.Name</td>
            <td>@(item.Type == "file" ? "Файл" : "Папка")</td>
            <td>@item.DeletedAt?.ToLocalTime().ToString("g")</td>
            <td>
                <button class="btn btn-sm btn-success" onclick="restoreItem('@item.Id','@item.Type')">Восстановить</button>
                <button class="btn btn-sm btn-danger" onclick="deleteItem('@item.Id','@item.Type')">Удалить</button>
            </td>
        </tr>
    }
    </tbody>
</table>

@section Scripts {
<script>
async function restoreItem(id, type) {
    const url = type === 'file' ? `/api/trash/restore/file/${id}` : `/api/trash/restore/folder/${id}`;
    try {
        const res = await fetchWithProgress(url, { method: 'POST', credentials: 'include' });
        if (!res.ok) {
            const message = await res.text();
            alert(message || 'Не удалось восстановить объект');
            return;
        }
        const row = document.getElementById(`item-${id}`);
        if (row) row.remove();
        alert('Объект возвращён в исходную папку');
    } catch (err) {
        alert(`Ошибка при восстановлении: ${err.message}`);
    }
}

async function deleteItem(id, type) {
    if (!confirm('Удалить окончательно?')) return;
    const url = type === 'file' ? `/api/trash/file/${id}` : `/api/trash/folder/${id}`;
    try {
        const res = await fetchWithProgress(url, { method: 'DELETE', credentials: 'include' });
        if (!res.ok) {
            const message = await res.text();
            alert(message || 'Не удалось удалить объект');
            return;
        }
        const row = document.getElementById(`item-${id}`);
        if (row) row.remove();
    } catch (err) {
        alert(`Ошибка при удалении: ${err.message}`);
    }
}
</script>
}
